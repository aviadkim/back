# הארכיטקטורת Vertical Slice במערכת ניתוח מסמכים פיננסיים

## מהי ארכיטקטורת Vertical Slice?

ארכיטקטורת Vertical Slice היא גישה בארגון קוד אשר מארגנת את הקוד סביב תכונות עסקיות (Features) במקום שכבות טכנולוגיות. במודל מסורתי (Layered Architecture), הקוד מאורגן לפי שכבות טכניות כגון Controllers, Services, Repositories וכו'. בניגוד לכך, ב-Vertical Slice כל "חתיכה אנכית" מכילה את כל השכבות הטכניות הדרושות לממש תכונה עסקית שלמה.

![Vertical Slice vs. Layered Architecture](https://i.imgur.com/WjOwZZQ.png)

## היתרונות של גישת Vertical Slice

1. **קוהרנטיות ביישום תכונות (Feature Cohesion)** - כל הקוד הקשור לתכונה מסוימת נמצא באותו מקום, מה שמקל על הבנת הקוד ועל תחזוקה שלו.

2. **הפחתת צימוד (Reduced Coupling)** - תכונות שונות תלויות פחות אחת בשנייה, מה שמקל על שינויים ועדכונים בלי להשפיע על חלקים אחרים של המערכת.

3. **התאמה טובה יותר לעולם העסקי** - המבנה מתאים יותר לאופן בו אנשי עסקים חושבים על המערכת (בתכונות עסקיות).

4. **קלות בפיתוח צוותי** - צוותים שונים יכולים לעבוד על תכונות שונות ללא התנגשויות.

5. **פריסה עצמאית (Independent Deployment)** - ניתן לפרוס תכונות באופן נפרד לאחר שפיתוחן הושלם.

6. **פיתוח הדרגתי (Incremental Development)** - קל יותר לפתח תכונה אחת מתחילתה ועד סופה במקום לפתח שכבה שלמה שמשפיעה על כל התכונות.

## מבנה הפרויקט

בפרויקט שלנו אימצנו את ארכיטקטורת ה-Vertical Slice עם המבנה הבא:

```
/workspaces/back/
├── features/                   # התיקייה הראשית לתכונות
│   ├── pdf_scanning/           # תכונת סריקת PDF
│   │   ├── api.py             # נקודות קצה HTTP
│   │   ├── models.py          # מודלים ייעודיים לתכונה
│   │   ├── services.py        # שירותים עסקיים של התכונה
│   │   ├── tests/             # בדיקות לתכונה
│   │   └── __init__.py
│   │
│   ├── table_creation/         # תכונת יצירת טבלאות (לפיתוח עתידי)
│   │
│   ├── chatbot/                # תכונת צ'אטבוט (לפיתוח עתידי)
│   │
│   └── __init__.py
│
├── shared/                     # קוד משותף לכל התכונות
│   ├── database.py            # תשתית מסד נתונים
│   ├── pdf_utils.py           # כלי עזר לעבודה עם PDF
│   ├── ai_utils.py            # כלי עזר למודלי AI
│   ├── file_utils.py          # כלי עזר לעבודה עם קבצים
│   └── __init__.py
│
├── app.py                     # נקודת הכניסה הראשית לאפליקציה
├── setup.py                   # סקריפט הקמה
└── .env                       # משתני סביבה
```

## איך לפתח תכונה חדשה

בעת פיתוח תכונה חדשה, יש לעקוב אחר השלבים הבאים:

### 1. יצירת מבנה התיקיות

```bash
mkdir -p features/my_feature/tests
touch features/my_feature/__init__.py
touch features/my_feature/tests/__init__.py
```

### 2. יצירת הקבצים הבסיסיים

- **api.py** - הגדרת נקודות קצה HTTP
- **models.py** - הגדרת מודלים לנתונים
- **services.py** - הגדרת שירותים עסקיים

### 3. ייצוא ה-Blueprint ב-__init__.py

```python
from .api import my_feature_bp

__all__ = ['my_feature_bp']
```

### 4. רישום ה-Blueprint ב-app.py

```python
from features.my_feature import my_feature_bp
app.register_blueprint(my_feature_bp)
```

### 5. כתיבת בדיקות

יש לכתוב בדיקות לתכונה בתיקיית tests.

## עקרונות מנחים בפיתוח

1. **מודולריות** - כל תכונה צריכה להיות עצמאית ככל האפשר.

2. **שימוש ב-Inversion of Control** - במקום תלות ישירה בין תכונות, יש להשתמש בהזרקת תלויות או בהעברת פונקציות.

3. **הימנעות מצימוד מיותר** - תכונה אחת לא אמורה לגשת ישירות לקוד של תכונה אחרת. יש להשתמש ב-API המוגדר.

4. **קוד משותף ב-shared** - קוד משותף בין תכונות שונות צריך להיות בתיקיית shared.

5. **בדיקות ממוקדות** - כל תכונה צריכה להיבדק בנפרד ובאופן יסודי.

## תהליך עבודה מומלץ עם Git

1. **סניף לכל תכונה** - יש ליצור סניף Git ייעודי לכל תכונה:

   ```bash
   git checkout -b feature/pdf-scanning
   ```

2. **פיתוח מלא של התכונה** - לפתח את התכונה במלואה בסניף הייעודי, כולל בדיקות.

3. **בדיקות לוקליות** - לוודא שכל הבדיקות עוברות לפני מיזוג:

   ```bash
   python -m pytest features/pdf_scanning/tests/
   ```

4. **בקשת משיכה (Pull Request)** - יצירת PR למיזוג התכונה לסניף הראשי.

5. **סקירת קוד** - אחד מחברי הצוות סוקר את הקוד לפני מיזוג.

6. **מיזוג לסניף ראשי** - לאחר אישור, מיזוג לסניף ראשי והתחלת עבודה על תכונה חדשה.

## דוגמה מפורטת: תכונת סריקת PDF

תכונת סריקת PDF היא דוגמה מעשית לארכיטקטורת Vertical Slice. נבחן את המבנה שלה:

### api.py

מגדיר את נקודות הקצה HTTP לתכונה, לדוגמה:
- `POST /api/pdf/upload` - להעלאת PDF
- `GET /api/pdf/<document_id>` - לקבלת פרטי מסמך
- `GET /api/pdf/` - לקבלת רשימת מסמכים

זוהי השכבה החיצונית המתקשרת עם המשתמש.

### models.py

מגדיר את המודלים לנתונים של התכונה, לדוגמה:
- `ScannedDocument` - מודל לייצוג מסמך סרוק
- `SQLScannedDocument` - מודל SQL למסמך סרוק

זוהי שכבת הנתונים של התכונה.

### services.py

מכיל את הלוגיקה העסקית של התכונה, לדוגמה:
- `PDFScanningService` - שירות לסריקת מסמכי PDF וחילוץ מידע מהם

זוהי שכבת הלוגיקה העסקית של התכונה.

### tests/

מכיל בדיקות ספציפיות לתכונה, הבודקות את כל השכבות: ה-API, השירותים והמודלים.

## סיכום

ארכיטקטורת Vertical Slice מאפשרת לנו לפתח את מערכת ניתוח המסמכים הפיננסיים בצורה מודולרית, יעילה ומקבילית. היא מקלה על הבנת הקוד, על תחזוקה שלו ועל פיתוח תכונות חדשות.

כל תכונה היא יחידה שלמה ועצמאית, המכילה את כל השכבות הדרושות למימושה. גישה זו מתאימה במיוחד לפרויקט שלנו, שבו יש מספר תכונות מוגדרות היטב (סריקת PDF, יצירת טבלאות, צ'אטבוט) הדורשות טיפול נפרד וייחודי.
