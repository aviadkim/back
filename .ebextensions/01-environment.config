option_settings:
  aws:elasticbeanstalk:application:environment:
    USE_DYNAMODB: true
    DYNAMODB_REGION: eu-central-1
    PORT: 8080
    FLASK_ENV: production
    PYTHONPATH: "/var/app/current:$PYTHONPATH"
  
  aws:elasticbeanstalk:container:python:
    WSGIPath: app:app
    
  aws:autoscaling:launchconfiguration:
    InstanceType: t2.micro
    
container_commands:
  01_get_secrets:
    command: |
      aws ssm get-parameter --name "SECRET_KEY" --with-decryption --region eu-central-1 --query Parameter.Value --output text > /tmp/secret_key || echo "random_secret_key" > /tmp/secret_key
      aws ssm get-parameter --name "JWT_SECRET" --with-decryption --region eu-central-1 --query Parameter.Value --output text > /tmp/jwt_secret || echo "random_jwt_secret" > /tmp/jwt_secret
      aws ssm get-parameter --name "HUGGINGFACE_API_KEY" --with-decryption --region eu-central-1 --query Parameter.Value --output text > /tmp/huggingface_key || echo "No HuggingFace key found" > /tmp/huggingface_key
  
  02_set_env_vars:
    command: |
      echo "export SECRET_KEY=$(cat /tmp/secret_key)" >> /opt/elasticbeanstalk/deployment/env
      echo "export JWT_SECRET=$(cat /tmp/jwt_secret)" >> /opt/elasticbeanstalk/deployment/env
      echo "export HUGGINGFACE_API_KEY=$(cat /tmp/huggingface_key)" >> /opt/elasticbeanstalk/deployment/env
  
  03_cleanup:
    command: |
      rm -f /tmp/secret_key /tmp/jwt_secret /tmp/huggingface_key
